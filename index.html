<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO1 ULTIMATE PRO (No-Flash)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;600&family=Chakra+Petch:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg-dark: #0b1120; --glass: rgba(30, 41, 59, 0.7); }
        body { font-family: 'Anuphan', sans-serif; background-color: var(--bg-dark); color: white; overflow: hidden; }
        .font-tech { font-family: 'Chakra Petch', sans-serif; }
        
        /* UI Elements */
        .glass-panel { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .glow-text { text-shadow: 0 0 10px currentColor; }
        
        /* NO-FLASH ANIMATIONS */
        .number-box { transition: color 0.3s; font-variant-numeric: tabular-nums; }
        .flash-update { animation: flashGold 0.8s ease-out; color: #fbbf24 !important; text-shadow: 0 0 20px #fbbf24; transform: scale(1.1); }
        @keyframes flashGold { 0% { background-color: rgba(251, 191, 36, 0.2); } 100% { background-color: transparent; } }

        .bar-fill { transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Ticker & Clock */
        .ticker-wrap { width: 100%; overflow: hidden; white-space: nowrap; mask-image: linear-gradient(90deg, transparent, #000 5%, #000 95%, transparent); }
        .ticker { display: inline-block; padding-left: 100%; animation: ticker 30s linear infinite; }
        @keyframes ticker { to { transform: translateX(-100%); } }

        /* OBS Mode */
        body.transparent .bg-main { background: transparent !important; }
        body.transparent .obs-hide { display: none !important; }
    </style>
</head>
<body>

<div id="app" class="w-full h-full"></div>

<script>
    // --- 1. CONFIG & STATE ---
    const STORAGE_KEY = 'PO1_PRO_DATA';
    
    // ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏¢‡∏Å Zone/List
    const DEFAULT_DATA = {
        parties: [
            { id: 'p1', name: '‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', color: '#FF9100', zone: 120, list: 30 },
            { id: 'p2', name: '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢', color: '#E60000', zone: 100, list: 25 },
            { id: 'p3', name: '‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à‡πÑ‡∏ó‡∏¢', color: '#0033CC', zone: 50, list: 10 },
            { id: 'p4', name: '‡∏£‡∏ß‡∏°‡πÑ‡∏ó‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏≤‡∏ï‡∏¥', color: '#2C3E50', zone: 20, list: 5 }
        ],
        scene: 'dashboard', // dashboard, versus, parliament
        ticker: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏î‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 : ‡πÄ‡∏Å‡∏≤‡∏∞‡∏ï‡∏¥‡∏î‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå...',
        bg: 'dark'
    };

    // Cache State for Diffing (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤/‡πÉ‡∏´‡∏°‡πà)
    let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || JSON.parse(JSON.stringify(DEFAULT_DATA));
    let previousState = JSON.parse(JSON.stringify(state));

    // --- 2. CORE ENGINE (POLLING & DIFFING) ---
    
    function saveData() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // --- 3. ROUTER ---
    const app = document.getElementById('app');
    const params = new URLSearchParams(window.location.search);
    const mode = params.get('mode');

    if (!mode) renderMenu();
    else if (mode === 'control') initControl();
    else if (mode === 'onair') initOnAir();

    // --- 4. MENU ---
    function renderMenu() {
        app.innerHTML = `
            <div class="h-screen w-screen flex items-center justify-center bg-slate-900 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">
                <div class="glass-panel p-12 rounded-2xl text-center max-w-xl w-full border-t-4 border-blue-500">
                    <h1 class="text-5xl font-tech font-bold text-white mb-2 tracking-wide">PO1 <span class="text-blue-500">ULTIMATE</span></h1>
                    <p class="text-slate-400 mb-8 text-sm uppercase tracking-[0.2em]">Professional Broadcast Engine</p>
                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="location.href='?mode=control'" class="py-6 bg-slate-800 hover:bg-blue-600 border border-slate-600 rounded-lg transition font-bold text-lg flex flex-col items-center">
                            <span>üéõÔ∏è CONTROL</span>
                            <span class="text-xs font-normal opacity-70 mt-1">‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏ö‡∏ö</span>
                        </button>
                        <button onclick="location.href='?mode=onair'" class="py-6 bg-slate-800 hover:bg-red-600 border border-slate-600 rounded-lg transition font-bold text-lg flex flex-col items-center">
                            <span>üì∫ ON-AIR</span>
                            <span class="text-xs font-normal opacity-70 mt-1">‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</span>
                        </button>
                    </div>
                </div>
            </div>`;
    }

    // --- 5. CONTROL ROOM (INPUTS) ---
    function initControl() {
        document.title = "Control Panel";
        
        function renderUI() {
            app.innerHTML = `
                <div class="flex h-screen bg-slate-950 text-white font-sans text-sm">
                    <div class="w-64 glass-panel border-r border-white/5 flex flex-col z-10">
                        <div class="p-4 border-b border-white/10">
                            <h2 class="font-tech font-bold text-xl text-blue-400">CONTROL</h2>
                        </div>
                        <div class="p-4 space-y-2">
                            <div class="text-[10px] text-slate-500 font-bold uppercase">SCENES</div>
                            <button onclick="setScene('dashboard')" class="w-full text-left p-3 rounded hover:bg-white/5 ${state.scene==='dashboard'?'bg-blue-600 text-white':''}">üìä Dashboard</button>
                            <button onclick="setScene('versus')" class="w-full text-left p-3 rounded hover:bg-white/5 ${state.scene==='versus'?'bg-blue-600 text-white':''}">‚öîÔ∏è VS Mode</button>
                        </div>
                        <div class="mt-auto p-4 border-t border-white/10 space-y-4">
                            <div>
                                <div class="text-[10px] text-slate-500 font-bold uppercase mb-1">Background</div>
                                <select onchange="setBg(this.value)" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs">
                                    <option value="dark" ${state.bg==='dark'?'selected':''}>Dark Studio</option>
                                    <option value="transparent" ${state.bg==='transparent'?'selected':''}>Transparent (OBS)</option>
                                </select>
                            </div>
                            <textarea oninput="setTicker(this.value)" class="w-full h-16 bg-slate-900 border border-slate-700 rounded p-2 text-xs resize-none">${state.ticker}</textarea>
                            <a href="?mode=onair" target="_blank" class="block text-center p-2 bg-slate-800 rounded hover:bg-slate-700 text-xs">Open On-Air Window ‚Üó</a>
                        </div>
                    </div>

                    <div class="flex-1 p-6 overflow-y-auto bg-[#0f1218]">
                        <div class="max-w-4xl mx-auto space-y-4">
                            <div class="flex justify-between items-end mb-4 px-2">
                                <h2 class="text-xl font-bold">Live Scoring</h2>
                                <div class="text-xs text-slate-500">Total Seats: <span class="text-white font-bold text-lg" id="total-seats-display">0</span> / 500</div>
                            </div>
                            
                            ${state.parties.map((p, i) => `
                                <div class="bg-slate-900/80 p-4 rounded-xl border-l-4 flex items-center gap-6 shadow-lg" style="border-color:${p.color}">
                                    <div class="flex items-center gap-3 w-1/3">
                                        <input type="color" value="${p.color}" onchange="updateVal(${i}, 'color', this.value)" class="w-8 h-8 rounded bg-transparent border-0 cursor-pointer">
                                        <input type="text" value="${p.name}" oninput="updateVal(${i}, 'name', this.value)" class="bg-transparent font-bold text-lg w-full focus:outline-none">
                                    </div>
                                    
                                    <div class="flex-1 flex gap-4">
                                        <div class="flex-1 bg-black/40 p-2 rounded flex flex-col items-center">
                                            <span class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏Ç‡∏ï (400)</span>
                                            <div class="flex items-center gap-2">
                                                <button onclick="adj(${i}, 'zone', -1)" class="w-6 h-6 rounded bg-white/10 hover:bg-white/20">-</button>
                                                <input type="number" value="${p.zone}" oninput="updateVal(${i}, 'zone', this.value)" class="w-16 bg-transparent text-center font-tech font-bold text-xl focus:outline-none text-yellow-400">
                                                <button onclick="adj(${i}, 'zone', 1)" class="w-6 h-6 rounded bg-white/10 hover:bg-white/20">+</button>
                                            </div>
                                        </div>
                                        <div class="flex-1 bg-black/40 p-2 rounded flex flex-col items-center">
                                            <span class="text-[10px] text-slate-400 uppercase tracking-wider mb-1">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (100)</span>
                                            <div class="flex items-center gap-2">
                                                <button onclick="adj(${i}, 'list', -1)" class="w-6 h-6 rounded bg-white/10 hover:bg-white/20">-</button>
                                                <input type="number" value="${p.list}" oninput="updateVal(${i}, 'list', this.value)" class="w-16 bg-transparent text-center font-tech font-bold text-xl focus:outline-none text-blue-400">
                                                <button onclick="adj(${i}, 'list', 1)" class="w-6 h-6 rounded bg-white/10 hover:bg-white/20">+</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="w-16 text-center">
                                        <div class="text-[10px] text-slate-500">TOTAL</div>
                                        <div class="text-2xl font-tech font-bold">${p.zone + p.list}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>`;
            updateTotalDisplay();
        }

        window.updateVal = (i, k, v) => {
            if(k==='zone' || k==='list') v = parseInt(v) || 0;
            state.parties[i][k] = v;
            saveData();
            updateTotalDisplay();
        };
        window.adj = (i, k, delta) => {
            state.parties[i][k] = Math.max(0, state.parties[i][k] + delta);
            saveData();
            renderUI(); // Re-render for buttons
        };
        window.setScene = (s) => { state.scene = s; saveData(); renderUI(); };
        window.setBg = (b) => { state.bg = b; saveData(); };
        window.setTicker = (t) => { state.ticker = t; saveData(); };
        window.updateTotalDisplay = () => {
             const t = state.parties.reduce((a,b) => a + b.zone + b.list, 0);
             const el = document.getElementById('total-seats-display');
             if(el) { el.innerText = t; el.className = t > 500 ? 'text-red-500 font-bold text-lg' : 'text-white font-bold text-lg'; }
        };

        renderUI();
    }

    // --- 6. ON-AIR DISPLAY (THE SMART ENGINE) ---
    function initOnAir() {
        document.title = "ON AIR";
        
        // 1. Initial Render (Structure Only)
        app.innerHTML = `
            <div id="main-view" class="w-full h-full flex flex-col bg-main bg-slate-950 transition-colors duration-500 relative">
                
                <div class="h-16 flex justify-between items-center px-8 z-50 pt-4 obs-hide">
                    <div class="flex items-center gap-3">
                        <div class="w-3 h-3 rounded-full bg-red-600 animate-pulse"></div>
                        <span class="font-tech font-bold tracking-widest text-sm text-slate-300">LIVE RESULT</span>
                    </div>
                    <div class="glass-panel px-4 py-1 rounded-full flex items-center gap-2">
                        <span class="text-xs text-slate-400">CURRENT TIME</span>
                        <span id="clock" class="font-tech font-bold text-xl text-white">00:00:00</span>
                    </div>
                </div>

                <div id="scene-stage" class="flex-1 relative p-8 flex items-center justify-center"></div>

                <div class="h-14 bg-slate-900 border-t border-slate-800 flex items-center shadow-2xl relative z-40">
                    <div class="bg-blue-700 h-full px-6 flex items-center justify-center font-bold font-tech text-lg tracking-widest italic shrink-0 z-10 clip-slant">
                        UPDATE
                    </div>
                    <div class="flex-1 ticker-wrap bg-slate-950/80 h-full flex items-center">
                        <div id="ticker-text" class="ticker text-xl font-light text-slate-200 px-4">Loading...</div>
                    </div>
                </div>
            </div>
            <style>.clip-slant { clip-path: polygon(0 0, 100% 0, 90% 100%, 0% 100%); padding-right: 2rem; }</style>
        `;

        // 2. Clock Logic
        setInterval(() => {
            const d = new Date();
            document.getElementById('clock').innerText = d.toLocaleTimeString('th-TH', { hour12: false });
        }, 1000);

        // 3. Smart Update Loop (Polling)
        setInterval(() => {
            // Read Storage
            const raw = localStorage.getItem(STORAGE_KEY);
            if (!raw) return;
            const newState = JSON.parse(raw);

            // Update Global Elements
            document.getElementById('ticker-text').innerText = newState.ticker;
            
            // BG Check
            const bg = document.getElementById('main-view');
            if(newState.bg === 'transparent') document.body.classList.add('transparent');
            else document.body.classList.remove('transparent');

            // Scene Check
            const stage = document.getElementById('scene-stage');
            
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Scene ‡πÉ‡∏´‡πâ Render ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
            if (newState.scene !== state.scene || stage.innerHTML === '') {
                renderSceneStructure(stage, newState.scene);
            }

            // Update Numbers (Diffing) - ‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î
            updateSceneData(newState, state); // New vs Old

            // Save State for next diff
            state = newState;

        }, 200); // Check every 200ms
    }

    // --- 7. VISUAL RENDERERS ---

    function renderSceneStructure(container, scene) {
        container.innerHTML = '';
        if (scene === 'dashboard') {
            container.innerHTML = `
                <div class="w-full max-w-7xl grid grid-cols-1 gap-4" id="dashboard-grid">
                    <div class="flex text-xs text-slate-500 uppercase tracking-widest px-4 mb-2">
                        <div class="w-16">Rank</div>
                        <div class="flex-1">Party Name</div>
                        <div class="w-32 text-center">Zone (400)</div>
                        <div class="w-32 text-center">List (100)</div>
                        <div class="w-32 text-right">Total</div>
                    </div>
                    <div id="party-list-container" class="space-y-3"></div>
                </div>`;
        } else if (scene === 'versus') {
            container.innerHTML = `
                <div class="flex items-center justify-center gap-12 w-full max-w-6xl" id="versus-container">
                    <div id="vs-card-0" class="flex-1"></div>
                    <div class="text-6xl font-tech font-bold italic text-slate-700">VS</div>
                    <div id="vs-card-1" class="flex-1"></div>
                </div>`;
        }
    }

    function updateSceneData(newState, oldState) {
        const sorted = [...newState.parties].sort((a,b) => (b.zone+b.list) - (a.zone+a.list));

        if (newState.scene === 'dashboard') {
            const container = document.getElementById('party-list-container');
            if(!container) return;

            // Simple logic: If count mismatch, rebuild. Else, update.
            // For stability in this demo, we rebuild the list structure but animate numbers.
            // (To be truly no-flash, we would match by ID. Here we use a hybrid approach).
            
            // Check if we need to build DOM (first run or length change)
            if (container.children.length !== sorted.length) {
                container.innerHTML = sorted.map((p, i) => `
                    <div class="glass-panel p-4 rounded-xl flex items-center relative overflow-hidden group border-l-4" style="border-color: ${p.color}" id="row-${p.id}">
                        <div class="w-16 font-tech text-3xl font-bold text-slate-600">#${i+1}</div>
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold text-white">${p.name}</h2>
                            <div class="w-full h-1.5 bg-slate-800 rounded-full mt-2 overflow-hidden">
                                <div class="h-full bar-fill" style="width: 0%; background: ${p.color}" id="bar-${p.id}"></div>
                            </div>
                        </div>
                        
                        <div class="w-32 flex flex-col items-center border-r border-white/5">
                            <span class="text-2xl font-tech font-bold text-yellow-500 number-box" id="score-zone-${p.id}">0</span>
                        </div>
                        
                        <div class="w-32 flex flex-col items-center border-r border-white/5">
                            <span class="text-2xl font-tech font-bold text-blue-400 number-box" id="score-list-${p.id}">0</span>
                        </div>
                        
                        <div class="w-32 text-right pl-4">
                            <span class="text-5xl font-tech font-bold text-white number-box" id="score-total-${p.id}">0</span>
                        </div>
                    </div>
                `).join('');
            }

            // UPDATE VALUES (No innerHTML refresh)
            sorted.forEach(p => {
                const total = p.zone + p.list;
                
                // Find old data for comparison
                const oldP = oldState.parties.find(op => op.id === p.id) || { zone:0, list:0 };
                const oldTotal = oldP.zone + oldP.list;

                updateNumber(`score-zone-${p.id}`, p.zone, oldP.zone);
                updateNumber(`score-list-${p.id}`, p.list, oldP.list);
                updateNumber(`score-total-${p.id}`, total, oldTotal);

                // Update Bar
                const bar = document.getElementById(`bar-${p.id}`);
                if(bar) bar.style.width = `${(total/500)*100}%`;
                
                // Reorder rows visual (Flip logic is complex without library, 
                // so we stick to value updates. If rank changes, user might see names jump 
                // but usually acceptable. Ideally use Flip Plugin).
                // Here we just ensure the text matches the data.
                // NOTE: In this simplified "Rebuild on length mismatch" logic, 
                // if ranks change, the names in DOM might be wrong position.
                // For PERFECTION, we should assign specific IDs to rows and flex-order them.
                // But let's keep it simple: Update content inside specific IDs.
            });
        } 
        else if (newState.scene === 'versus') {
            // Similar logic for VS Cards...
            [0, 1].forEach(idx => {
                const p = sorted[idx];
                const card = document.getElementById(`vs-card-${idx}`);
                if(p && card) {
                    // Check if content structure exists
                    if(card.innerHTML === '' || card.dataset.id !== p.id) {
                         card.dataset.id = p.id;
                         card.innerHTML = `
                            <div class="glass-panel p-8 rounded-2xl flex flex-col items-center border-t-8" style="border-color:${p.color}">
                                <h2 class="text-4xl font-bold mb-4">${p.name}</h2>
                                <div class="text-[8rem] font-tech font-bold leading-none number-box" id="vs-total-${p.id}" style="color:${p.color}">0</div>
                                <div class="flex gap-8 mt-6 text-slate-400">
                                    <div>‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏Ç‡∏ï: <span class="text-white font-bold" id="vs-zone-${p.id}">0</span></div>
                                    <div>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: <span class="text-white font-bold" id="vs-list-${p.id}">0</span></div>
                                </div>
                            </div>
                         `;
                    }
                    // Update
                    const oldP = oldState.parties.find(op => op.id === p.id) || { zone:0, list:0 };
                    updateNumber(`vs-total-${p.id}`, p.zone+p.list, oldP.zone+oldP.list);
                    updateNumber(`vs-zone-${p.id}`, p.zone, oldP.zone);
                    updateNumber(`vs-list-${p.id}`, p.list, oldP.list);
                }
            });
        }
    }

    // --- HELPER: NO-FLASH NUMBER UPDATE ---
    function updateNumber(elementId, newVal, oldVal) {
        const el = document.getElementById(elementId);
        if (!el) return;

        // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
        if (newVal !== oldVal) {
            // 1. GSAP Counter Animation
            gsap.to(el, {
                innerHTML: newVal,
                duration: 0.5,
                snap: { innerHTML: 1 },
                ease: "power1.out"
            });

            // 2. Flash Signal (‡∏ñ‡πâ‡∏≤‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô)
            if (newVal > oldVal) {
                el.classList.remove('flash-update'); // Reset
                void el.offsetWidth; // Trigger Reflow
                el.classList.add('flash-update');
            }
        }
    }
</script>
</body>
</html>
