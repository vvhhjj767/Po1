import React, { useState, useEffect, useMemo, useCallback } from 'react';
import { 
  Tv, Settings, Eye, EyeOff, LayoutDashboard, Columns, Maximize, 
  Users, PauseCircle, PlayCircle, AlertTriangle, ExternalLink, 
  RotateCcw, CheckCircle2, Wifi, WifiOff
} from 'lucide-react';

/**
 * --- 1. ROBUST UTILITIES (เครื่องมือกันระบบพัง) ---
 */

// Safe Storage: อ่านค่าแบบปลอดภัย ถ้าพังให้คืนค่า null ทันที ไม่ให้แอปจอขาว
const safeStorage = {
  getItem: (key) => {
    try { 
      const val = localStorage.getItem(key);
      if (!val) return null;
      // ลอง Parse ดู ถ้าพังให้ return null ไปเลย
      const parsed = JSON.parse(val);
      if (!parsed || typeof parsed !== 'object') return null;
      return parsed;
    } catch (e) { 
      console.warn("Storage Error, resetting...", e);
      return null; 
    }
  },
  setItem: (key, value) => {
    try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { /* ignore */ }
  },
  clear: (key) => {
    try { localStorage.removeItem(key); } catch (e) { /* ignore */ }
  }
};

// Safe Broadcast: ตัวส่งสัญญาณข้ามจอ (ถ้า Browser ไม่รองรับ จะไม่ error)
class SafeBroadcast {
  constructor(name) {
    this.name = name;
    this.channel = null;
    this.isSupported = false;
    try {
      if (typeof window !== 'undefined' && window.BroadcastChannel) {
        this.channel = new BroadcastChannel(name);
        this.isSupported = true;
      }
    } catch (e) { console.warn("BroadcastChannel not supported"); }
  }
  postMessage(msg) {
    try { this.channel?.postMessage(msg); } catch (e) { /* ignore */ }
  }
  set onmessage(handler) {
    if (this.channel) this.channel.onmessage = handler;
  }
}

const channel = new SafeBroadcast('election_channel_v3_stable');

/**
 * --- 2. DATA CONSTANTS ---
 */
const SCENES = {
  OVERVIEW_500: 'OVERVIEW_500',
  SPLIT_SEATS: 'SPLIT_SEATS',
  PARTY_FOCUS: 'PARTY_FOCUS',
  COALITION: 'COALITION',
  STANDBY: 'STANDBY'
};

const INITIAL_PARTIES = [
  { id: "MFP", name_th: "พรรคก้าวไกล", name_en: "Move Forward", color: "#F47524", logo: "Tri", seats: { constituency: 112, party_list: 39 }, visible: true, isCoalition: false },
  { id: "PTP", name_th: "พรรคเพื่อไทย", name_en: "Pheu Thai", color: "#E60000", logo: "Cir", seats: { constituency: 112, party_list: 29 }, visible: true, isCoalition: true },
  { id: "BJT", name_th: "พรรคภูมิใจไทย", name_en: "Bhumjaithai", color: "#003082", logo: "Cir", seats: { constituency: 68, party_list: 3 }, visible: true, isCoalition: true },
  { id: "PPRP", name_th: "พรรคพลังประชารัฐ", name_en: "PPRP", color: "#1F4F9C", logo: "Cir", seats: { constituency: 39, party_list: 1 }, visible: true, isCoalition: false },
  { id: "UTN", name_th: "พรรครวมไทยสร้างชาติ", name_en: "UTN", color: "#2D4472", logo: "Hex", seats: { constituency: 23, party_list: 13 }, visible: true, isCoalition: false }
];

const DEFAULT_STATE = {
  parties: INITIAL_PARTIES,
  scene: SCENES.OVERVIEW_500,
  focusedPartyId: INITIAL_PARTIES[0].id,
  isFrozen: false,
  isStandby: false
};

// Helper Functions
const calculateTotal = (p) => (p?.seats?.constituency || 0) + (p?.seats?.party_list || 0);

const PartyLogo = ({ type, color, className }) => {
  const style = { fill: color };
  try {
    if (type === 'Tri') return <svg viewBox="0 0 24 24" className={className} style={style}><path d="M12 2L2 22h20L12 2z" /></svg>;
    if (type === 'Hex') return <svg viewBox="0 0 24 24" className={className} style={style}><path d="M12 2l8.5 5v10L12 22l-8.5-5V7L12 2z" /></svg>;
    return <svg viewBox="0 0 24 24" className={className} style={style}><circle cx="12" cy="12" r="10" /></svg>;
  } catch (e) { return <div className={className} style={{background: color}} />; }
};

/**
 * --- 3. COMPONENTS ---
 */

// --- ON AIR DISPLAY (หน้าจอแสดงผล) ---
const OnAirDisplay = ({ embedded = false }) => {
  // Load initial state with fallback
  const [state, setState] = useState(() => {
    const saved = safeStorage.getItem('election_state_v3');
    return saved && Array.isArray(saved.parties) ? saved : DEFAULT_STATE;
  });

  // Listeners
  useEffect(() => {
    const handleMsg = (event) => {
      if (!event?.data) return;
      const { type, payload } = event.data;
      
      if (type === 'FREEZE') {
        setState(prev => ({ ...prev, isFrozen: payload }));
        return;
      }
      if (state.isFrozen && type !== 'FREEZE') return; // Ignore if frozen
      if (type === 'UPDATE_FULL_STATE' && payload) setState(payload);
    };

    channel.onmessage = handleMsg;

    // Backup: Storage Event
    const handleStorage = (e) => {
      if (e.key === 'election_state_v3' && e.newValue && !state.isFrozen) {
        const parsed = JSON.parse(e.newValue);
        if(parsed) setState(parsed);
      }
    };
    window.addEventListener('storage', handleStorage);
    return () => window.removeEventListener('storage', handleStorage);
  }, [state.isFrozen]);

  // Safe Sort
  const sortedParties = useMemo(() => {
    return (state.parties || []).filter(p => p && p.visible).sort((a, b) => calculateTotal(b) - calculateTotal(a));
  }, [state.parties]);

  const totalSeats = sortedParties.reduce((a, b) => a + calculateTotal(b), 0);

  // Scene Wrappers
  const Container = ({ children, className = "" }) => (
    <div className={`${embedded ? 'h-full p-4' : 'h-screen p-8'} bg-slate-900 text-white flex flex-col relative overflow-hidden ${className}`}>
      {children}
      {embedded && <div className="absolute top-2 right-2 text-[10px] text-white/30 font-mono border border-white/20 px-1 rounded">LIVE PREVIEW</div>}
    </div>
  );

  // 4.1 RENDER: Standby
  if (state.isStandby) {
    return (
      <div className={`flex flex-col items-center justify-center ${embedded ? 'h-full' : 'h-screen'} bg-black text-white`}>
        <div className="animate-pulse flex flex-col items-center">
          <AlertTriangle size={embedded ? 48 : 80} className="text-yellow-500 mb-4" />
          <h1 className={`${embedded ? 'text-2xl' : 'text-5xl'} font-bold tracking-widest`}>STANDBY</h1>
        </div>
      </div>
    );
  }

  // 4.2 RENDER: Scenes
  switch (state.scene) {
    case SCENES.SPLIT_SEATS:
      return (
        <Container>
           <div className="flex-1 grid grid-cols-2 gap-4">
             {/* เขต */}
             <div className="bg-slate-800/50 rounded-xl p-4 border border-white/10 flex flex-col">
               <h2 className={`font-bold text-center text-blue-400 mb-4 ${embedded ? 'text-xl' : 'text-3xl'}`}>แบ่งเขต (400)</h2>
               <div className="space-y-2 overflow-y-auto flex-1 pr-2">
                 {sortedParties.slice(0, 10).map(p => (
                   <div key={p.id} className="flex items-center gap-2">
                     <span className="font-mono w-8 text-right font-bold text-lg">{p.seats.constituency}</span>
                     <div className="flex-1 h-6 bg-slate-700 rounded overflow-hidden relative">
                       <div className="h-full absolute top-0 left-0 transition-all duration-500" style={{width: `${(p.seats.constituency/150)*100}%`, background: p.color}} />
                       <span className="absolute inset-0 flex items-center px-2 text-xs font-bold drop-shadow">{p.name_th}</span>
                     </div>
                   </div>
                 ))}
               </div>
             </div>
             {/* บัญชีรายชื่อ */}
             <div className="bg-slate-800/50 rounded-xl p-4 border border-white/10 flex flex-col">
               <h2 className={`font-bold text-center text-green-400 mb-4 ${embedded ? 'text-xl' : 'text-3xl'}`}>บัญชีรายชื่อ (100)</h2>
               <div className="space-y-2 overflow-y-auto flex-1 pr-2">
                 {sortedParties.slice(0, 10).map(p => (
                   <div key={p.id} className="flex items-center gap-2">
                     <span className="font-mono w-8 text-right font-bold text-lg">{p.seats.party_list}</span>
                     <div className="flex-1 h-6 bg-slate-700 rounded overflow-hidden relative">
                       <div className="h-full absolute top-0 left-0 transition-all duration-500" style={{width: `${(p.seats.party_list/50)*100}%`, background: p.color}} />
                       <span className="absolute inset-0 flex items-center px-2 text-xs font-bold drop-shadow">{p.name_th}</span>
                     </div>
                   </div>
                 ))}
               </div>
             </div>
           </div>
        </Container>
      );

    case SCENES.PARTY_FOCUS:
      const focusP = (state.parties || []).find(p => p.id === state.focusedPartyId) || sortedParties[0];
      if(!focusP) return <Container>No Party Selected</Container>;
      return (
        <Container>
           <div className="flex flex-col items-center justify-center h-full relative z-10">
             <div className="absolute inset-0 blur-3xl opacity-20 pointer-events-none" style={{background: `radial-gradient(circle, ${focusP.color}, transparent 70%)`}} />
             <PartyLogo type={focusP.logo} color={focusP.color} className={`${embedded ? 'w-24 h-24' : 'w-48 h-48'} mb-6 drop-shadow-lg`} />
             <h1 className={`${embedded ? 'text-4xl' : 'text-7xl'} font-black mb-2 text-center leading-tight`}>{focusP.name_th}</h1>
             <h2 className={`${embedded ? 'text-xl' : 'text-3xl'} text-slate-400 mb-8 uppercase tracking-widest`}>{focusP.name_en}</h2>
             
             <div className="grid grid-cols-2 gap-4 w-full max-w-2xl">
                <div className="bg-white/10 p-4 rounded-xl text-center backdrop-blur-sm border border-white/5">
                   <div className="text-slate-400 text-sm mb-1">ส.ส. เขต</div>
                   <div className={`${embedded ? 'text-4xl' : 'text-6xl'} font-bold`}>{focusP.seats.constituency}</div>
                </div>
                <div className="bg-white/10 p-4 rounded-xl text-center backdrop-blur-sm border border-white/5">
                   <div className="text-slate-400 text-sm mb-1">บัญชีรายชื่อ</div>
                   <div className={`${embedded ? 'text-4xl' : 'text-6xl'} font-bold`}>{focusP.seats.party_list}</div>
                </div>
             </div>
             <div className={`mt-6 font-black ${embedded ? 'text-6xl' : 'text-9xl'}`} style={{color: focusP.color}}>
                {calculateTotal(focusP)}
             </div>
           </div>
        </Container>
      );

    case SCENES.COALITION:
       const coalitionSum = sortedParties.filter(p => p.isCoalition).reduce((a,b) => a + calculateTotal(b), 0);
       return (
         <Container>
            <div className="flex flex-col items-center justify-center h-full">
               <h1 className="text-2xl text-slate-400 uppercase tracking-[0.5em] mb-8">Coalition Forming</h1>
               <div className={`${embedded ? 'text-8xl' : 'text-[10rem]'} font-black leading-none mb-4 ${coalitionSum >= 251 ? 'text-green-500' : 'text-white'}`}>
                  {coalitionSum}
               </div>
               <div className="h-4 w-full max-w-md bg-slate-800 rounded-full overflow-hidden mb-4 border border-slate-700">
                  <div className={`h-full ${coalitionSum >= 251 ? 'bg-green-500' : 'bg-blue-500'} transition-all duration-500`} style={{width: `${Math.min((coalitionSum/500)*100, 100)}%`}} />
               </div>
               <div className="text-slate-500">Target: 251 (Majority)</div>
               
               {coalitionSum >= 251 && (
                 <div className="mt-8 bg-green-600 text-black font-bold px-6 py-2 rounded-full animate-bounce shadow-lg shadow-green-500/50">
                    GOVERNMENT FORMED
                 </div>
               )}
            </div>
         </Container>
       );

    case SCENES.OVERVIEW_500:
    default:
      return (
        <Container>
           <div className="flex justify-between items-end mb-6 pb-2 border-b border-white/10">
              <h1 className={`${embedded ? 'text-xl' : 'text-4xl'} font-bold`}>ภาพรวมผลการเลือกตั้ง</h1>
              <div className="text-slate-400 font-mono">{totalSeats}/500</div>
           </div>
           <div className="flex-1 flex items-end justify-center gap-1 pb-4">
              {sortedParties.map(p => {
                 const total = calculateTotal(p);
                 const h = Math.max((total/200)*100, 5);
                 return (
                   <div key={p.id} className="flex-1 max-w-[100px] flex flex-col items-center group relative">
                      <div className={`${embedded ? 'text-xl' : 'text-3xl'} font-bold mb-2`}>{total}</div>
                      <div className="w-full rounded-t-md transition-all duration-500 shadow-lg group-hover:brightness-110" style={{height: `${h}%`, background: p.color}}></div>
                      <div className="mt-2 text-center w-full">
                         <div className={`${embedded ? 'text-[10px]' : 'text-sm'} text-slate-300 truncate`}>{p.name_th}</div>
                      </div>
                   </div>
                 )
              })}
           </div>
           {/* Majority Line */}
           <div className="absolute top-[45%] left-0 w-full border-t border-dashed border-white/20 pointer-events-none"></div>
        </Container>
      );
  }
};

// --- CONTROL PANEL (แผงควบคุม) ---
const ControlPanel = ({ appState, setAppState }) => {
  const { parties, scene, isFrozen, isStandby, focusedPartyId } = appState;

  // Handlers
  const updateParty = (id, field, value) => {
    if (isFrozen) return; // Lock inputs when frozen
    const newParties = parties.map(p => {
       if (p.id !== id) return p;
       if (field === 'visible') return { ...p, visible: !p.visible };
       if (field === 'coalition') return { ...p, isCoalition: !p.isCoalition };
       // Numeric fields
       const num = parseInt(value);
       if (isNaN(num)) return p;
       return { ...p, seats: { ...p.seats, [field]: num } };
    });
    setAppState({ ...appState, parties: newParties });
  };

  const switchScene = (s) => setAppState({ ...appState, scene: s });
  const toggleFreeze = () => setAppState({ ...appState, isFrozen: !isFrozen });
  const toggleStandby = () => setAppState({ ...appState, isStandby: !isStandby });
  
  return (
    <div className="h-full flex flex-col bg-slate-50 text-slate-900">
       {/* Toolbar */}
       <div className="bg-white border-b border-slate-200 p-3 shadow-sm flex flex-wrap gap-3 items-center justify-between">
          <div className="flex items-center gap-2 font-bold text-slate-700">
            <Settings size={18} /> CONTROLS
          </div>
          <div className="flex gap-2">
             <button onClick={toggleFreeze} className={`px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-all ${isFrozen ? 'bg-red-600 text-white shadow-red-200 shadow-lg ring-2 ring-red-400' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                {isFrozen ? <PlayCircle size={18} /> : <PauseCircle size={18} />} {isFrozen ? 'UNFREEZE SCREEN' : 'FREEZE SCREEN'}
             </button>
             <button onClick={toggleStandby} className={`px-4 py-2 rounded-lg font-bold flex items-center gap-2 transition-all ${isStandby ? 'bg-amber-500 text-white shadow-amber-200 shadow-lg' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                <AlertTriangle size={18} /> {isStandby ? 'LIVE MODE' : 'STANDBY MODE'}
             </button>
          </div>
       </div>

       <div className="flex-1 overflow-hidden flex">
          {/* Scenes Sidebar */}
          <div className="w-64 bg-slate-100 border-r border-slate-200 p-3 flex flex-col gap-2 overflow-y-auto">
             <div className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Select Scene</div>
             {[
               {id: SCENES.OVERVIEW_500, label: 'Overview', icon: LayoutDashboard},
               {id: SCENES.SPLIT_SEATS, label: 'Split Seats', icon: Columns},
               {id: SCENES.PARTY_FOCUS, label: 'Party Focus', icon: Maximize},
               {id: SCENES.COALITION, label: 'Coalition Calc', icon: Users},
             ].map(s => (
               <button 
                 key={s.id} 
                 onClick={() => switchScene(s.id)}
                 className={`p-3 rounded-xl text-left flex items-center gap-3 font-medium transition-all ${scene === s.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/30' : 'bg-white hover:bg-slate-200 text-slate-700 border border-slate-200'}`}
               >
                 <s.icon size={18} /> {s.label}
               </button>
             ))}
          </div>

          {/* Party Data Table */}
          <div className="flex-1 p-4 overflow-y-auto bg-slate-50">
             <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <table className="w-full text-sm">
                   <thead className="bg-slate-100 text-slate-500 font-medium border-b border-slate-200">
                      <tr>
                         <th className="p-3 w-12 text-center">Vis</th>
                         <th className="p-3 w-12 text-center">Coal.</th>
                         <th className="p-3 text-left">Party Name</th>
                         <th className="p-3 w-24 text-center bg-blue-50/50">Const.</th>
                         <th className="p-3 w-24 text-center bg-green-50/50">List</th>
                         <th className="p-3 w-20 text-center">Total</th>
                         <th className="p-3 w-16 text-center">Action</th>
                      </tr>
                   </thead>
                   <tbody className="divide-y divide-slate-100">
                      {parties.map(p => (
                        <tr key={p.id} className="hover:bg-slate-50 group transition-colors">
                           <td className="p-2 text-center">
                             <button onClick={() => updateParty(p.id, 'visible')} className={`p-2 rounded-lg ${p.visible ? 'text-blue-600 bg-blue-50' : 'text-slate-300'}`}>
                               {p.visible ? <Eye size={16}/> : <EyeOff size={16}/>}
                             </button>
                           </td>
                           <td className="p-2 text-center">
                             <input type="checkbox" checked={p.isCoalition} onChange={() => updateParty(p.id, 'coalition')} className="w-4 h-4 accent-blue-600 cursor-pointer"/>
                           </td>
                           <td className="p-2">
                              <div className="flex items-center gap-3">
                                 <div className="w-8 h-8 rounded-lg flex items-center justify-center text-white text-[10px] font-bold shadow-sm" style={{background: p.color}}>{p.id}</div>
                                 <div className="font-bold text-slate-700">{p.name_th}</div>
                              </div>
                           </td>
                           <td className="p-2 text-center bg-blue-50/30">
                              <input type="number" value={p.seats.constituency} onChange={(e) => updateParty(p.id, 'constituency', e.target.value)} 
                                className="w-full text-center border border-slate-200 rounded-md p-1 font-mono font-bold focus:ring-2 focus:ring-blue-500 outline-none"
                              />
                           </td>
                           <td className="p-2 text-center bg-green-50/30">
                              <input type="number" value={p.seats.party_list} onChange={(e) => updateParty(p.id, 'party_list', e.target.value)} 
                                className="w-full text-center border border-slate-200 rounded-md p-1 font-mono font-bold focus:ring-2 focus:ring-green-500 outline-none"
                              />
                           </td>
                           <td className="p-2 text-center font-black text-lg text-slate-700">{calculateTotal(p)}</td>
                           <td className="p-2 text-center">
                              <button 
                                onClick={() => { setAppState(prev => ({ ...prev, focusedPartyId: p.id, scene: SCENES.PARTY_FOCUS })); }} 
                                className={`p-2 rounded-lg transition-colors ${focusedPartyId === p.id && scene === SCENES.PARTY_FOCUS ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-blue-600 hover:bg-blue-50'}`}
                              >
                                 <Maximize size={16} />
                              </button>
                           </td>
                        </tr>
                      ))}
                   </tbody>
                </table>
             </div>
          </div>
       </div>
    </div>
  );
};

// --- APP ROOT ---
const App = () => {
  const [mode, setMode] = useState('split'); // 'split', 'control_only', 'onair_only'
  
  // ROOT STATE: Initialize with Safe Storage or Factory Defaults
  const [appState, setAppState] = useState(() => {
    const saved = safeStorage.getItem('election_state_v3');
    return (saved && Array.isArray(saved.parties)) ? saved : DEFAULT_STATE;
  });

  // 1. Sync State to Storage & Channel
  useEffect(() => {
    safeStorage.setItem('election_state_v3', appState);
    channel.postMessage({ type: 'UPDATE_FULL_STATE', payload: appState });
  }, [appState]);

  // 2. Handle Hash Routing (For new tabs)
  useEffect(() => {
    if (window.location.hash === '#/onair') setMode('onair_only');
  }, []);

  // 3. Factory Reset Function
  const factoryReset = () => {
    if(confirm("Reset all data to defaults? This will clear current counts.")) {
      safeStorage.clear('election_state_v3');
      setAppState(DEFAULT_STATE);
      window.location.reload();
    }
  };

  const openPopup = () => {
    window.open(window.location.origin + window.location.pathname + '#/onair', 'onair_popup', 'width=1280,height=720');
  };

  // RENDER: Fullscreen On-Air Mode
  if (mode === 'onair_only') return <OnAirDisplay />;

  // RENDER: Main Interface
  return (
    <div className="h-screen w-screen flex flex-col bg-slate-900 overflow-hidden font-sans">
       {/* Top Bar */}
       <header className="h-14 bg-slate-800 border-b border-slate-700 flex items-center justify-between px-4 shrink-0 shadow-lg z-50">
          <div className="flex items-center gap-3">
             <div className="bg-gradient-to-br from-blue-600 to-blue-700 p-2 rounded-lg shadow-lg shadow-blue-500/20">
               <Tv size={20} className="text-white" />
             </div>
             <div>
               <h1 className="font-bold text-white tracking-wide text-lg leading-none">ELECTION CONTROL</h1>
               <div className="text-slate-400 text-[10px] font-mono mt-1 flex items-center gap-2">
                 <span className="flex items-center gap-1 text-green-400"><CheckCircle2 size={10}/> SYSTEM READY</span>
                 <span>|</span>
                 <span>v3.0.1 (Stable)</span>
               </div>
             </div>
          </div>

          <div className="flex items-center gap-3">
             {/* View Modes */}
             <div className="bg-slate-900 p-1 rounded-lg border border-slate-700 flex">
                <button onClick={() => setMode('control_only')} className={`px-3 py-1.5 text-xs rounded-md font-medium flex items-center gap-2 transition-all ${mode === 'control_only' ? 'bg-slate-700 text-white shadow' : 'text-slate-400 hover:text-white'}`}>
                   <Settings size={14} /> Control Only
                </button>
                <button onClick={() => setMode('split')} className={`px-3 py-1.5 text-xs rounded-md font-medium flex items-center gap-2 transition-all ${mode === 'split' ? 'bg-blue-600 text-white shadow' : 'text-slate-400 hover:text-white'}`}>
                   <Columns size={14} /> Split View
                </button>
             </div>

             <div className="h-6 w-[1px] bg-slate-700 mx-1"></div>

             {/* Actions */}
             <button onClick={openPopup} className="px-3 py-1.5 text-xs rounded-lg font-medium flex items-center gap-2 text-green-400 hover:bg-green-400/10 border border-green-400/20 hover:border-green-400/50 transition-all">
                <ExternalLink size={14} /> Open Popup Window
             </button>
             
             <button onClick={factoryReset} className="px-3 py-1.5 text-xs rounded-lg font-medium flex items-center gap-2 text-red-400 hover:bg-red-400/10 border border-red-400/20 hover:border-red-400/50 transition-all" title="Clear Data & Reset">
                <RotateCcw size={14} /> Reset
             </button>
          </div>
       </header>

       {/* Workspace */}
       <div className="flex-1 flex overflow-hidden relative">
          {/* Left: Control Panel */}
          <div className={`${mode === 'split' ? 'w-1/2' : 'w-full'} h-full transition-all duration-300 relative z-10 bg-white`}>
             <ControlPanel appState={appState} setAppState={setAppState} />
          </div>

          {/* Right: Live Preview */}
          {mode === 'split' && (
             <div className="w-1/2 h-full bg-black border-l border-slate-700 relative shadow-2xl z-0 flex flex-col">
                <div className="bg-slate-950 px-3 py-1 flex justify-between items-center border-b border-slate-800">
                  <div className="flex items-center gap-2">
                    <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <span className="text-[10px] text-slate-300 font-bold tracking-wider">LIVE OUTPUT PREVIEW</span>
                  </div>
                  <div className="text-[10px] text-slate-600">1920x1080 (Scaled)</div>
                </div>
                <div className="flex-1 relative">
                  <OnAirDisplay embedded={true} />
                </div>
             </div>
          )}
       </div>
    </div>
  );
};

export default App;
