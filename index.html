<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO1 Professional Broadcast</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;400;600&family=Kanit:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Anuphan', sans-serif; background-color: #0f172a; color: white; overflow: hidden; }
        .font-display { font-family: 'Kanit', sans-serif; }
        
        /* Glass Effect */
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .glass-panel { background: rgba(15, 23, 42, 0.9); border-right: 1px solid rgba(255,255,255,0.05); }

        /* Animations */
        .number-change { transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .bar-fill { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Ticker */
        .ticker-wrap { width: 100%; overflow: hidden; white-space: nowrap; mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent); }
        .ticker { display: inline-block; padding-left: 100%; animation: ticker 30s linear infinite; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* OBS Transparent Mode */
        body.transparent-mode { background-color: transparent !important; }
        body.transparent-mode .bg-slate-950 { background-color: transparent !important; }
        body.transparent-mode #viz-area { background-color: transparent !important; }
    </style>
</head>
<body>

<div id="app" class="w-full h-full"></div>

<script>
    // --- 1. CONFIGURATION ---
    // ‡πÉ‡∏ä‡πâ EMQX Public Broker (‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Å‡∏ß‡πà‡∏≤ HiveMQ)
    const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt';
    
    const DEFAULT_STATE = {
        roomId: 'NEWS-ROOM-1', // Default Room Name
        parties: [
            { id: 'p1', name: '‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', color: '#FF7F00', constituency: 100, partylist: 25 },
            { id: 'p2', name: '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢', color: '#E60000', constituency: 90, partylist: 20 },
            { id: 'p3', name: '‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à‡πÑ‡∏ó‡∏¢', color: '#0033CC', constituency: 50, partylist: 10 },
            { id: 'p4', name: '‡∏£‡∏ß‡∏°‡πÑ‡∏ó‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏≤‡∏ï‡∏¥', color: '#2C3E50', constituency: 30, partylist: 5 }
        ],
        scene: 'parliament', // parliament, leaderboard, coalition, winner
        bgMode: 'dark',
        ticker: '‡πÄ‡∏Å‡∏≤‡∏∞‡∏ï‡∏¥‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á 2569 ‡∏ï‡∏•‡∏≠‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô...'
    };

    let state = JSON.parse(localStorage.getItem('po1_final_data')) || JSON.parse(JSON.stringify(DEFAULT_STATE));
    let client = null;
    let isConnected = false;

    // --- 2. NETWORK ENGINE (The Core) ---
    
    function initNetwork(role) {
        const clientId = 'client_' + Math.random().toString(16).substr(2, 8);
        const topic = `po1/live/${state.roomId}`;

        console.log(`üì° Connecting to Cloud (${role})...`);
        updateStatus('CONNECTING...', 'yellow');

        client = mqtt.connect(MQTT_BROKER, {
            clientId: clientId,
            keepalive: 60,
            clean: true, // Clean session
            reconnectPeriod: 2000
        });

        client.on('connect', () => {
            console.log('‚úÖ Connected!');
            isConnected = true;
            updateStatus('ONLINE', 'green');
            
            if (role === 'control') {
                // Control: Publish current state immediately (Retain=True)
                publishState(); 
            } else {
                // On-Air: Subscribe to get the retained message
                client.subscribe(topic, { qos: 0 });
            }
        });

        client.on('message', (t, msg) => {
            if (role === 'onair') {
                try {
                    const incoming = JSON.parse(msg.toString());
                    // Update state & Render
                    state = incoming;
                    if(window.renderScene) window.renderScene();
                } catch (e) { console.error(e); }
            }
        });

        client.on('offline', () => { isConnected = false; updateStatus('OFFLINE', 'red'); });
    }

    function publishState() {
        if (!client || !isConnected) return;
        localStorage.setItem('po1_final_data', JSON.stringify(state));
        
        // KEY FEATURE: retain: true
        // Server ‡∏à‡∏∞‡∏à‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ ‡πÉ‡∏Ñ‡∏£‡∏ï‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
        client.publish(`po1/live/${state.roomId}`, JSON.stringify(state), { qos: 0, retain: true });
    }

    // --- 3. ROUTER ---
    const app = document.getElementById('app');
    const params = new URLSearchParams(window.location.search);
    const page = params.get('page');

    if (!page) renderLanding();
    else if (page === 'control') { renderControl(); initNetwork('control'); }
    else if (page === 'onair') { renderOnAir(); initNetwork('onair'); }

    // --- 4. LANDING PAGE ---
    function renderLanding() {
        app.innerHTML = `
            <div class="h-screen w-screen flex flex-col items-center justify-center bg-slate-950 p-4">
                <div class="glass p-10 rounded-2xl max-w-lg w-full text-center space-y-6">
                    <h1 class="text-5xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-500">PO1 SYSTEM</h1>
                    <div class="text-slate-400 text-sm">Professional Broadcast Engine</div>
                    
                    <div class="text-left">
                        <label class="text-xs font-bold text-slate-500 uppercase ml-1">ROOM ID (‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á)</label>
                        <input id="roomInput" type="text" value="${state.roomId}" class="w-full mt-1 bg-slate-900 border border-slate-700 p-4 rounded-xl text-xl font-bold text-center text-white focus:border-blue-500 outline-none uppercase placeholder-slate-600" placeholder="EX. NEWS-1">
                        <p class="text-[10px] text-slate-500 mt-2 text-center text-red-400">*‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á 2 ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 pt-4">
                        <button onclick="goTo('control')" class="bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-bold transition flex flex-col items-center gap-1">
                            <span class="text-2xl">üéõÔ∏è</span>
                            <span>CONTROL</span>
                        </button>
                        <button onclick="goTo('onair')" class="bg-red-600 hover:bg-red-500 py-4 rounded-xl font-bold transition flex flex-col items-center gap-1">
                            <span class="text-2xl">üì∫</span>
                            <span>ON-AIR</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    window.goTo = (p) => {
        state.roomId = document.getElementById('roomInput').value.toUpperCase();
        localStorage.setItem('po1_final_data', JSON.stringify(state));
        window.location.href = `?page=${p}`;
    };

    // --- 5. CONTROL ROOM ---
    function renderControl() {
        document.title = "Control Room - " + state.roomId;
        
        window.updateVal = (id, k, v) => {
            const p = state.parties.find(x=>x.id===id);
            p[k] = (k==='constituency'||k==='partylist') ? (parseInt(v)||0) : v;
            renderPartyList(); publishState();
        };

        window.setScene = (s) => { state.scene = s; publishState(); updateUI(); };
        window.setBg = (m) => { state.bgMode = m; publishState(); };
        
        app.innerHTML = `
            <div class="flex h-screen bg-slate-900 text-slate-200">
                <div class="w-64 glass-panel flex flex-col p-4 gap-4">
                    <div class="pb-4 border-b border-slate-700">
                        <div class="text-[10px] text-slate-500 font-bold uppercase">CONNECTED TO</div>
                        <div class="font-mono text-xl font-bold text-blue-400 truncate">${state.roomId}</div>
                        <div id="status-badge" class="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-yellow-500/20 text-yellow-500 mt-1">CONNECTING...</div>
                    </div>

                    <div class="space-y-2">
                        <div class="text-[10px] text-slate-500 font-bold uppercase">SCENES</div>
                        <button id="btn-parliament" onclick="setScene('parliament')" class="scene-btn">üèõÔ∏è Parliament</button>
                        <button id="btn-leaderboard" onclick="setScene('leaderboard')" class="scene-btn">üèÜ Leaderboard</button>
                        <button id="btn-coalition" onclick="setScene('coalition')" class="scene-btn">ü§ù Coalition</button>
                        <button id="btn-winner" onclick="setScene('winner')" class="scene-btn">üëë Winner</button>
                    </div>

                    <div class="mt-auto pt-4 border-t border-slate-700">
                        <div class="text-[10px] text-slate-500 font-bold uppercase mb-2">BACKGROUND</div>
                        <select onchange="setBg(this.value)" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-xs">
                            <option value="dark">Standard Dark</option>
                            <option value="transparent">Transparent (OBS)</option>
                        </select>
                        <div class="text-[10px] text-slate-500 font-bold uppercase mt-4 mb-2">TICKER TEXT</div>
                        <textarea oninput="state.ticker=this.value; publishState();" class="w-full bg-slate-800 border border-slate-600 rounded p-2 text-xs h-20 resize-none">${state.ticker}</textarea>
                    </div>
                </div>

                <div class="flex-1 p-6 overflow-y-auto bg-slate-950">
                    <div id="party-container" class="max-w-4xl mx-auto space-y-3"></div>
                </div>
            </div>
            <style>.scene-btn { width:100%; text-align:left; padding:10px; border-radius:8px; background:rgba(255,255,255,0.05); transition:0.2s; font-weight:bold; } .scene-btn:hover { background:rgba(255,255,255,0.1); } .scene-btn.active { background:#2563eb; color:white; }</style>
        `;
        renderPartyList(); updateUI();
    }

    function renderPartyList() {
        const sorted = [...state.parties].sort((a,b)=>(b.constituency+b.partylist)-(a.constituency+a.partylist));
        document.getElementById('party-container').innerHTML = sorted.map(p => `
            <div class="glass p-4 rounded-xl flex items-center gap-4 border-l-4 transition-all hover:bg-slate-800" style="border-color:${p.color}">
                <input type="color" value="${p.color}" onchange="updateVal('${p.id}','color',this.value)" class="w-12 h-12 rounded-lg bg-transparent cursor-pointer border-0">
                <input type="text" value="${p.name}" oninput="updateVal('${p.id}','name',this.value)" class="bg-transparent font-display font-bold text-2xl flex-1 focus:outline-none border-b border-transparent focus:border-slate-500 pb-1">
                
                <div class="flex gap-6">
                    <div class="flex flex-col items-center">
                        <span class="text-[10px] text-slate-500 uppercase font-bold">‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏Ç‡∏ï</span>
                        <input type="number" value="${p.constituency}" oninput="updateVal('${p.id}','constituency',this.value)" class="w-24 bg-slate-900 text-center font-mono text-2xl font-bold rounded-lg py-2 focus:outline-none focus:ring-2 ring-blue-500 text-white">
                    </div>
                    <div class="flex flex-col items-center">
                        <span class="text-[10px] text-slate-500 uppercase font-bold">‡∏õ‡∏≤‡∏£‡πå‡∏ï‡∏µ‡πâ‡∏•‡∏¥‡∏™‡∏ï‡πå</span>
                        <input type="number" value="${p.partylist}" oninput="updateVal('${p.id}','partylist',this.value)" class="w-24 bg-slate-900 text-center font-mono text-2xl font-bold rounded-lg py-2 focus:outline-none focus:ring-2 ring-indigo-500 text-white">
                    </div>
                </div>
            </div>
        `).join('');
    }

    function updateUI() {
        document.querySelectorAll('.scene-btn').forEach(b=>b.classList.remove('active'));
        const btn = document.getElementById('btn-'+state.scene);
        if(btn) btn.classList.add('active');
    }

    function updateStatus(msg, color) {
        const el = document.getElementById('status-badge');
        if(el) {
            const map = { green: 'bg-green-500/20 text-green-500', red: 'bg-red-500/20 text-red-500', yellow: 'bg-yellow-500/20 text-yellow-500' };
            el.className = `inline-block px-2 py-0.5 rounded text-[10px] font-bold mt-1 ${map[color]}`;
            el.innerText = msg;
        }
    }

    // --- 6. ON-AIR DISPLAY ---
    function renderOnAir() {
        document.title = "On-Air Output";
        app.innerHTML = `
            <div id="viz-area" class="w-full h-full flex flex-col bg-slate-950 transition-colors duration-500">
                <div id="viz-container" class="flex-1 relative flex items-center justify-center p-8 overflow-hidden"></div>
                
                <div class="h-16 flex shrink-0 border-t border-slate-800 bg-slate-900 shadow-2xl z-50">
                    <div class="bg-red-600 px-8 flex items-center justify-center">
                        <span class="font-display font-bold text-white tracking-widest animate-pulse">LIVE</span>
                    </div>
                    <div class="flex-1 ticker-wrap flex items-center bg-slate-900">
                        <div id="ticker" class="ticker font-display text-2xl px-4 text-slate-300"></div>
                    </div>
                </div>
            </div>
        `;
        window.renderScene();
    }

    window.renderScene = () => {
        // Handle Background
        if(state.bgMode === 'transparent') document.body.classList.add('transparent-mode');
        else document.body.classList.remove('transparent-mode');

        document.getElementById('ticker').innerText = state.ticker;
        
        const container = document.getElementById('viz-container');
        container.innerHTML = ''; // Clear

        const sorted = [...state.parties].sort((a,b)=>(b.constituency+b.partylist)-(a.constituency+a.partylist));

        if(state.scene === 'parliament') drawParliament(container, sorted);
        else if(state.scene === 'leaderboard') drawLeaderboard(container, sorted);
        else if(state.scene === 'coalition') drawCoalition(container, sorted);
        else if(state.scene === 'winner') drawWinner(container, sorted);
    };

    // --- 7. VISUALIZATIONS (Graphics) ---

    function drawParliament(el, parties) {
        let dots = []; let idx = 0;
        let colorMap = []; parties.forEach(p=>{ for(let i=0;i<p.constituency+p.partylist;i++) colorMap.push(p.color); });
        
        // 500 Seats Semicircle Algorithm
        for(let r=0; r<12; r++) {
            const radius = 35 + (r * 4.5);
            const count = Math.floor(18 + r * 5); const step = 180/(count-1);
            for(let a=0; a<count; a++) {
                if(idx>=500) break;
                const rad = (180-(a*step))*(Math.PI/180);
                dots.push({ x: 50+radius*Math.cos(rad), y: 90-radius*Math.sin(rad), c: colorMap[idx]||'#334155' });
                idx++;
            }
        }

        let html = `<div class="relative w-[1100px] aspect-[2/1] origin-bottom scale-90">`;
        dots.forEach(d => {
            html += `<div class="absolute w-[1.2%] pb-[1.2%] rounded-full transition-colors duration-700" style="left:${d.x}%; top:${d.y}%; background:${d.c}; transform:translate(-50%,-50%); box-shadow:0 0 5px ${d.c}66;"></div>`;
        });
        
        const top = parties[0];
        if(top) {
            html += `
            <div class="absolute bottom-0 left-1/2 -translate-x-1/2 text-center glass px-12 py-6 rounded-2xl border border-white/10 shadow-2xl backdrop-blur-xl">
                <div class="text-xs text-slate-400 uppercase tracking-widest mb-1">UNOFFICIAL RESULTS</div>
                <h1 class="text-5xl font-display font-bold mb-2 text-white drop-shadow-lg">${top.name}</h1>
                <div class="text-8xl font-mono font-bold number-change" style="color:${top.color}; text-shadow:0 0 30px ${top.color}44;">${top.constituency+top.partylist}</div>
            </div>`;
        }
        html += `</div>`;
        el.innerHTML = html;
    }

    function drawLeaderboard(el, parties) {
        let html = `<div class="w-full max-w-5xl space-y-4">`;
        parties.forEach((p, i) => {
            const total = p.constituency+p.partylist;
            const pct = (total/500)*100;
            html += `
                <div class="glass p-4 rounded-xl flex items-center gap-6 relative overflow-hidden group">
                    <div class="font-mono text-4xl font-bold text-slate-600 w-12 text-center z-10">${i+1}</div>
                    <div class="flex-1 z-10">
                        <div class="flex justify-between items-end mb-2">
                            <h2 class="text-3xl font-display font-bold text-white">${p.name}</h2>
                            <span class="text-4xl font-mono font-bold number-change" style="color:${p.color}">${total}</span>
                        </div>
                        <div class="w-full h-4 bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full bar-fill" style="width:${pct}%; background:${p.color}; box-shadow:0 0 15px ${p.color};"></div>
                        </div>
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-${p.color}/10 to-transparent opacity-0 group-hover:opacity-20 transition duration-500"></div>
                </div>
            `;
        });
        html += `</div>`;
        el.innerHTML = html;
    }

    function drawCoalition(el, parties) {
        // Just visualizing composition
        let html = `<div class="w-full max-w-6xl text-center">
            <h2 class="text-5xl font-display font-bold mb-12 text-white drop-shadow-lg">Parliament Composition</h2>
            <div class="h-32 w-full bg-slate-800 rounded-full overflow-hidden flex shadow-2xl border-4 border-slate-700 relative mb-8">
                ${parties.map(p => `
                    <div style="width:${((p.constituency+p.partylist)/500)*100}%; background:${p.color}" class="h-full bar-fill relative border-r border-black/10"></div>
                `).join('')}
                <div class="absolute top-0 bottom-0 w-1 bg-white left-[50.2%] z-20 shadow-[0_0_20px_white]"></div>
                <div class="absolute -top-12 left-[50.2%] -translate-x-1/2 bg-white text-black px-4 py-1 rounded-full font-bold shadow-lg">TARGET 251</div>
            </div>
            <div class="flex justify-center flex-wrap gap-4">
                 ${parties.map(p => `
                    <div class="glass px-6 py-3 rounded-lg flex items-center gap-3 border-b-4" style="border-color:${p.color}">
                        <div class="font-bold text-xl">${p.name}</div>
                        <div class="font-mono text-2xl font-bold text-slate-300">${p.constituency+p.partylist}</div>
                    </div>
                `).join('')}
            </div>
        </div>`;
        el.innerHTML = html;
    }

    function drawWinner(el, parties) {
        const w = parties[0];
        el.innerHTML = `
            <div class="text-center relative z-10">
                <div class="absolute inset-0 bg-${w.color} blur-[150px] opacity-20 z-0"></div>
                <div class="glass p-20 rounded-3xl border border-white/20 shadow-2xl relative z-10">
                    <div class="text-6xl mb-6 animate-bounce">üèÜ</div>
                    <div class="text-2xl font-bold text-slate-400 tracking-[0.5em] mb-4 uppercase">Projected Winner</div>
                    <h1 class="text-8xl font-display font-bold text-white mb-8 drop-shadow-xl">${w.name}</h1>
                    <div class="text-[10rem] font-mono font-bold leading-none number-change" style="color:${w.color}; text-shadow:0 0 50px ${w.color};">${w.constituency+w.partylist}</div>
                </div>
            </div>
        `;
    }

</script>
</body>
</html>
