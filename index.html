<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PO1 Election System V4 (P2P)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Anuphan:wght@300;500;600&family=Kanit:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Anuphan', sans-serif; background-color: #020617; color: white; overflow: hidden; }
        .font-display { font-family: 'Kanit', sans-serif; }
        
        /* Glassmorphism */
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .glass-strong { background: rgba(2, 6, 23, 0.95); border: 1px solid rgba(255,255,255,0.1); }
        
        /* Animations */
        .bar-fill { transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .number-flip { transition: color 0.3s; }
        
        /* Ticker */
        .ticker-wrap { width: 100%; overflow: hidden; white-space: nowrap; }
        .ticker { display: inline-block; padding-left: 100%; animation: ticker 30s linear infinite; }
        @keyframes ticker { 0% { transform: translate3d(0, 0, 0); } 100% { transform: translate3d(-100%, 0, 0); } }

        /* Transparent Mode */
        body.transparent-mode { background: transparent !important; }
        body.transparent-mode .bg-main { background: transparent !important; }
    </style>
</head>
<body>

<div id="app" class="h-screen w-screen relative"></div>

<script>
    // --- 1. DEFAULT DATA ---
    const DEFAULT_STATE = {
        parties: [
            { id: 'p1', name: '‡∏û‡∏£‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', color: '#FF7F00', constituency: 120, partylist: 30, coalition: false },
            { id: 'p2', name: '‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢', color: '#E60000', constituency: 100, partylist: 20, coalition: false },
            { id: 'p3', name: '‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à‡πÑ‡∏ó‡∏¢', color: '#0033CC', constituency: 50, partylist: 10, coalition: false },
            { id: 'p4', name: '‡∏£‡∏ß‡∏°‡πÑ‡∏ó‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏≤‡∏ï‡∏¥', color: '#2C3E50', constituency: 20, partylist: 5, coalition: false }
        ],
        scene: 'leaderboard', // parliament, leaderboard, vs, victory
        ticker: '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏î‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£...',
        bgMode: 'dark' // dark, transparent, green
    };

    let state = JSON.parse(localStorage.getItem('po1_v4_state')) || JSON.parse(JSON.stringify(DEFAULT_STATE));
    let peer = null;
    let conn = null;
    let myId = '';

    // --- 2. P2P NETWORKING (The Stable One) ---
    
    function initHost(customId) {
        // Host (Control Room) creates the "Room"
        peer = new Peer(customId);
        
        peer.on('open', (id) => {
            myId = id;
            console.log('Host Open:', id);
            renderControl(); // Re-render to show status
        });

        peer.on('connection', (c) => {
            console.log('Client connected!');
            conn = c;
            // Send initial data immediately
            setTimeout(() => sendData(), 500);
            
            conn.on('open', () => { alert('üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); });
        });

        peer.on('error', (err) => {
            alert('‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + err.type);
        });
    }

    function initClient(targetId) {
        // Client (On-Air) connects to Host
        peer = new Peer(); // Auto ID
        
        peer.on('open', () => {
            conn = peer.connect(targetId);
            
            conn.on('open', () => {
                console.log('Connected to Host');
                renderOnAirStatus('ONLINE', 'text-green-500');
            });

            conn.on('data', (data) => {
                console.log('Received:', data);
                state = data;
                if(window.drawOnAir) window.drawOnAir();
            });
            
            conn.on('close', () => renderOnAirStatus('DISCONNECTED', 'text-red-500'));
        });

        peer.on('error', (err) => {
            console.log(err);
            renderOnAirStatus('ERROR: ' + err.type, 'text-red-500');
        });
    }

    function sendData() {
        if(conn && conn.open) {
            conn.send(state);
        }
        localStorage.setItem('po1_v4_state', JSON.stringify(state));
    }

    // --- 3. ROUTING ---
    const app = document.getElementById('app');
    const params = new URLSearchParams(window.location.search);
    const page = params.get('page');

    if(!page) renderLanding();
    else if(page === 'control') { renderControl(); if(params.get('room')) initHost(params.get('room')); }
    else if(page === 'onair') { renderOnAir(); if(params.get('room')) initClient(params.get('room')); }

    // --- 4. LANDING PAGE ---
    function renderLanding() {
        const randomId = 'po1-' + Math.floor(Math.random() * 9999);
        app.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full bg-slate-950 p-6 space-y-8">
                <div class="text-center">
                    <h1 class="text-6xl font-display font-bold text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-red-600">PO1 SYSTEM V4</h1>
                    <p class="text-slate-400 mt-2">P2P Direct Connection ‚Ä¢ Stable & Real-time</p>
                </div>

                <div class="glass p-8 rounded-2xl w-full max-w-lg space-y-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á (Room ID)</label>
                        <input type="text" id="roomId" value="${randomId}" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-4 text-center text-xl font-mono font-bold focus:border-orange-500 outline-none transition">
                        <p class="text-xs text-slate-500 mt-2 text-center">‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <button onclick="go('control')" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 py-4 rounded-xl flex flex-col items-center gap-2 transition group">
                            <span class="text-3xl">üéõÔ∏è</span>
                            <span class="font-bold group-hover:text-orange-400">‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (Host)</span>
                        </button>
                        <button onclick="go('onair')" class="bg-red-900/50 hover:bg-red-900/80 border border-red-800 py-4 rounded-xl flex flex-col items-center gap-2 transition group">
                            <span class="text-3xl">üì∫</span>
                            <span class="font-bold group-hover:text-red-300">‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Client)</span>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    window.go = (mode) => {
        const room = document.getElementById('roomId').value;
        window.location.href = `?page=${mode}&room=${room}`;
    };

    // --- 5. CONTROL PAGE ---
    function renderControl() {
        document.title = "Control Room";
        
        window.updateParty = (id, key, val) => {
            const p = state.parties.find(x => x.id === id);
            if(key === 'constituency' || key === 'partylist') p[key] = parseInt(val) || 0;
            else p[key] = val;
            renderPartyList(); sendData();
        };

        window.setScene = (s) => { state.scene = s; sendData(); updateControlUI(); };
        window.setBg = (m) => { state.bgMode = m; sendData(); };
        window.addParty = () => { state.parties.push({id:'p'+Date.now(), name:'New Party', color:'#666', constituency:0, partylist:0}); renderPartyList(); sendData(); };
        window.removeParty = (id) => { if(confirm('Lop?')) { state.parties = state.parties.filter(p=>p.id!==id); renderPartyList(); sendData(); }};

        app.innerHTML = `
            <div class="flex h-full bg-slate-950 text-slate-200">
                <div class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col">
                    <div class="p-4 border-b border-slate-800">
                        <div class="text-[10px] text-slate-500 uppercase">ROOM ID</div>
                        <div class="font-mono font-bold text-orange-500 truncate">${params.get('room')}</div>
                        <div class="text-[10px] text-green-500 mt-1">${myId ? '‚óè HOSTING' : '‚óã STARTING...'}</div>
                    </div>
                    
                    <div class="p-4 space-y-2 overflow-y-auto flex-1">
                        <div class="text-xs font-bold text-slate-500 uppercase">SCENES</div>
                        ${['parliament', 'leaderboard', 'vs', 'victory'].map(s => `
                            <button id="btn-${s}" onclick="setScene('${s}')" class="w-full text-left px-4 py-3 rounded border transition uppercase text-sm font-bold ${state.scene===s?'bg-orange-600 border-orange-500 text-white':'bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-700'}">
                                ${s}
                            </button>
                        `).join('')}
                        
                        <div class="mt-6 text-xs font-bold text-slate-500 uppercase">OUTPUT MODE</div>
                        <select onchange="setBg(this.value)" class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm mt-1">
                            <option value="dark">Standard Dark</option>
                            <option value="transparent">Transparent (OBS)</option>
                            <option value="green">Green Screen</option>
                        </select>

                        <div class="mt-6 text-xs font-bold text-slate-500 uppercase">TICKER</div>
                        <textarea onchange="state.ticker=this.value; sendData();" class="w-full bg-slate-800 border border-slate-700 rounded p-2 text-sm h-24 resize-none">${state.ticker}</textarea>
                    </div>
                </div>

                <div class="flex-1 flex flex-col">
                    <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-900">
                        <h1 class="text-xl font-display font-bold">Party Manager</h1>
                        <div class="text-sm font-mono text-slate-400">Total: <span class="text-white font-bold text-lg">${state.parties.reduce((a,b)=>a+b.constituency+b.partylist,0)}</span> / 500</div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 space-y-3 bg-slate-950">
                        <div id="party-list" class="space-y-2"></div>
                        <button onclick="addParty()" class="w-full py-3 border border-dashed border-slate-700 rounded text-slate-500 hover:bg-slate-900 hover:text-slate-300 transition">+ Add Party</button>
                    </div>
                </div>
            </div>
        `;
        renderPartyList();
    }

    function renderPartyList() {
        const sorted = [...state.parties].sort((a,b) => (b.constituency+b.partylist) - (a.constituency+a.partylist));
        document.getElementById('party-list').innerHTML = sorted.map(p => `
            <div class="bg-slate-900 p-3 rounded-lg border-l-4 flex items-center gap-4" style="border-color:${p.color}">
                <input type="color" value="${p.color}" onchange="updateParty('${p.id}','color',this.value)" class="w-8 h-8 rounded bg-transparent border-0 cursor-pointer">
                <input type="text" value="${p.name}" onchange="updateParty('${p.id}','name',this.value)" class="bg-transparent font-bold text-lg flex-1 focus:outline-none">
                
                <div class="flex items-center gap-2">
                    <div class="flex flex-col items-center bg-black/30 p-1 rounded">
                        <span class="text-[10px] text-slate-500">‡πÄ‡∏Ç‡∏ï</span>
                        <input type="number" value="${p.constituency}" onchange="updateParty('${p.id}','constituency',this.value)" class="w-16 bg-transparent text-center font-mono font-bold text-lg focus:outline-none">
                    </div>
                    <div class="flex flex-col items-center bg-black/30 p-1 rounded">
                        <span class="text-[10px] text-slate-500">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</span>
                        <input type="number" value="${p.partylist}" onchange="updateParty('${p.id}','partylist',this.value)" class="w-16 bg-transparent text-center font-mono font-bold text-lg focus:outline-none">
                    </div>
                </div>
                <button onclick="removeParty('${p.id}')" class="text-slate-600 hover:text-red-500 px-2">√ó</button>
            </div>
        `).join('');
    }

    // --- 6. ON-AIR PAGE ---
    function renderOnAir() {
        document.title = "On-Air Output";
        app.innerHTML = `
            <div id="wrapper" class="w-full h-full flex flex-col bg-main bg-slate-950 transition-colors duration-500">
                <div id="status-overlay" class="absolute top-2 right-2 text-[10px] font-mono bg-black/50 px-2 rounded text-yellow-500 z-50">CONNECTING...</div>

                <div id="viz" class="flex-1 relative flex items-center justify-center p-8 overflow-hidden"></div>

                <div class="h-14 bg-slate-900 border-t border-slate-800 flex items-center relative z-40 shadow-2xl">
                    <div class="bg-red-600 h-full flex items-center px-6 font-bold text-sm tracking-widest shrink-0 uppercase">Breaking News</div>
                    <div class="ticker-wrap h-full flex items-center text-lg font-display">
                        <div id="ticker-text" class="ticker px-4"></div>
                    </div>
                </div>
            </div>
        `;
        window.drawOnAir();
    }

    function renderOnAirStatus(msg, colorClass) {
        const el = document.getElementById('status-overlay');
        if(el) {
            el.innerText = msg;
            el.className = `absolute top-2 right-2 text-[10px] font-mono bg-black/50 px-2 rounded z-50 ${colorClass}`;
            if(msg === 'ONLINE') setTimeout(() => el.style.display = 'none', 3000); // Hide after connected
        }
    }

    window.drawOnAir = () => {
        const wrapper = document.getElementById('wrapper');
        const viz = document.getElementById('viz');
        const ticker = document.getElementById('ticker-text');
        
        // Handle BG
        if(state.bgMode === 'transparent') {
            document.body.classList.add('transparent-mode');
            wrapper.className = "w-full h-full flex flex-col bg-transparent";
        } else if(state.bgMode === 'green') {
            document.body.classList.remove('transparent-mode');
            wrapper.className = "w-full h-full flex flex-col bg-green-600";
        } else {
            document.body.classList.remove('transparent-mode');
            wrapper.className = "w-full h-full flex flex-col bg-slate-950";
        }

        ticker.innerText = state.ticker;

        // Render Scene
        viz.innerHTML = '';
        const sorted = [...state.parties].sort((a,b) => (b.constituency+b.partylist) - (a.constituency+a.partylist));
        
        if(state.scene === 'parliament') drawParliament(viz, sorted);
        else if(state.scene === 'leaderboard') drawLeaderboard(viz, sorted);
        else if(state.scene === 'vs') drawVS(viz, sorted);
        else if(state.scene === 'victory') drawVictory(viz, sorted);
    }

    // --- 7. VISUAL MODES ---

    // Mode 1: Parliament (‡πÄ‡∏î‡∏¥‡∏°)
    function drawParliament(container, parties) {
        let dots = []; let seatIdx = 0;
        let colorMap = []; parties.forEach(p => { for(let i=0;i<(p.constituency+p.partylist);i++) colorMap.push(p.color); });
        
        for(let r=0; r<12; r++) {
            const radius = 35 + (r * 4.5);
            const count = Math.floor(18 + r * 5); 
            const step = 180 / (count - 1);
            for(let a=0; a<count; a++) {
                if(seatIdx >= 500) break;
                const rad = (180 - (a * step)) * (Math.PI / 180);
                dots.push({ x: 50 + radius * Math.cos(rad), y: 95 - radius * Math.sin(rad), c: colorMap[seatIdx] || '#334155' });
                seatIdx++;
            }
        }
        let html = `<div class="relative w-[90%] max-w-[1100px] aspect-[2/1]">`;
        dots.forEach(d => html += `<div class="absolute w-[1.2%] pb-[1.2%] rounded-full transition-colors duration-500" style="left:${d.x}%; top:${d.y}%; background:${d.c}; transform:translate(-50%,-50%)"></div>`);
        if(parties[0]) html += `<div class="absolute bottom-0 left-1/2 -translate-x-1/2 text-center glass-strong px-10 py-6 rounded-2xl mb-4 border border-slate-700 shadow-2xl">
            <div class="text-xs text-slate-400 uppercase tracking-widest mb-1">Current Leader</div>
            <h1 class="text-4xl font-display font-bold text-white mb-2">${parties[0].name}</h1>
            <div class="text-6xl font-mono font-bold" style="color:${parties[0].color}">${parties[0].constituency+parties[0].partylist}</div>
        </div>`;
        html += `</div>`;
        container.innerHTML = html;
    }

    // Mode 2: Leaderboard (‡πÉ‡∏´‡∏°‡πà)
    function drawLeaderboard(container, parties) {
        let html = `<div class="w-full max-w-4xl space-y-4">
            <h2 class="text-3xl font-display font-bold mb-8 pl-2 border-l-4 border-orange-500">LIVE RESULTS</h2>`;
        
        parties.forEach((p, i) => {
            const total = p.constituency + p.partylist;
            const percent = (total / 500) * 100;
            html += `
                <div class="glass p-4 rounded-xl flex items-center gap-4 transition-all duration-500 hover:bg-slate-800/80">
                    <div class="font-mono text-2xl font-bold text-slate-500 w-8 text-center">${i+1}</div>
                    <div class="w-12 h-12 rounded-lg flex-shrink-0" style="background:${p.color}"></div>
                    <div class="flex-1">
                        <div class="flex justify-between items-end mb-1">
                            <span class="font-bold text-xl font-display">${p.name}</span>
                            <span class="font-mono font-bold text-2xl">${total}</span>
                        </div>
                        <div class="w-full h-3 bg-slate-800 rounded-full overflow-hidden">
                            <div class="h-full bar-fill" style="width:${percent}%; background:${p.color}"></div>
                        </div>
                    </div>
                </div>
            `;
        });
        html += `</div>`;
        container.innerHTML = html;
    }

    // Mode 3: VS Mode (‡πÉ‡∏´‡∏°‡πà)
    function drawVS(container, parties) {
        const p1 = parties[0] || {name:'-', constituency:0, partylist:0, color:'#333'};
        const p2 = parties[1] || {name:'-', constituency:0, partylist:0, color:'#333'};
        const t1 = p1.constituency + p1.partylist;
        const t2 = p2.constituency + p2.partylist;

        const card = (p, t, align) => `
            <div class="flex-1 glass-strong p-8 rounded-2xl border-t-8 flex flex-col justify-center ${align === 'right' ? 'items-end text-right' : 'items-start text-left'}" style="border-color:${p.color}">
                <div class="text-sm text-slate-400 uppercase tracking-widest mb-2">RANK ${align==='left'?'1':'2'}</div>
                <h1 class="text-5xl font-display font-bold mb-4 leading-tight">${p.name}</h1>
                <div class="text-[120px] font-mono font-bold leading-none mb-4" style="color:${p.color}">${t}</div>
                <div class="flex gap-4 text-sm text-slate-400 font-mono">
                    <div>‡πÄ‡∏Ç‡∏ï: <span class="text-white">${p.constituency}</span></div>
                    <div>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: <span class="text-white">${p.partylist}</span></div>
                </div>
            </div>
        `;

        container.innerHTML = `
            <div class="flex gap-12 w-full max-w-6xl items-center">
                ${card(p1, t1, 'left')}
                <div class="text-4xl font-bold font-display italic text-slate-600">VS</div>
                ${card(p2, t2, 'right')}
            </div>
        `;
    }

    // Mode 4: Victory (‡πÉ‡∏´‡∏°‡πà)
    function drawVictory(container, parties) {
        const winner = parties[0];
        const total = winner.constituency + winner.partylist;
        
        container.innerHTML = `
            <div class="text-center relative">
                <div class="absolute inset-0 bg-gradient-to-b from-transparent to-${winner.color} opacity-20 blur-3xl"></div>
                <div class="relative glass-strong p-16 rounded-3xl border border-white/10 shadow-[0_0_100px_rgba(0,0,0,0.5)]">
                    <div class="text-yellow-400 text-6xl mb-6 animate-bounce">üëë</div>
                    <div class="text-xl font-bold text-slate-400 uppercase tracking-[0.3em] mb-4">Unstatisfied Result Winner</div>
                    <h1 class="text-7xl font-display font-bold text-white mb-6 drop-shadow-lg">${winner.name}</h1>
                    <div class="text-9xl font-mono font-bold mb-8" style="color:${winner.color}">${total}</div>
                    <div class="inline-block bg-white/10 px-6 py-2 rounded-full text-sm font-mono text-white/80">
                        CONSTITUENCY: ${winner.constituency} ‚Ä¢ PARTY-LIST: ${winner.partylist}
                    </div>
                </div>
            </div>
        `;
    }

</script>
</body>
</html>
